import{v as B,E as F,D as S,A as I,r as j,J as W,q as N,n as k,X as q,j as c,F as x,G as T,p as U,I as $,a as G}from"./index-85b64ddc.js";import{_ as J,s as X}from"./index-62a9cd62.js";import{d as H,a as Y}from"./ViewInAr-fd4fa02b.js";import{u as _,D as M}from"./useFetchDatas-45e33e50.js";import{P as K}from"./Paper-ead7a250.js";import{B as V,a as w}from"./BottomNavigationAction-2b30d94e.js";import{O as Z}from"./transformToMeshBasicMaterial-58f46ad3.js";import"./Point-d3172315.js";import"./createTheme-a7bd8e9d.js";import"./createSvgIcon-c7bdef24.js";import"./createSvgIcon-0da8929c.js";import"./ButtonBase-4df208c3.js";import"./useControlled-e139503c.js";import"./useId-457cb0cd.js";const v=(e,o,n)=>{const i=new B,s=new F(e,o,n,"YXZ");return i.makeRotationFromEuler(s),i},Q=(e,{scale:o,rotation:n,position:i})=>{if(o&&e.scale.set(o,o,o),n){const[s,t,d]=n;s&&e.applyMatrix4(v(s,0,0)),t&&e.applyMatrix4(v(0,t,0)),d&&e.applyMatrix4(v(0,0,d))}return i&&e.position.set(i.x,i.y,i.z),e};var ee=(e,o,n)=>new Promise((i,s)=>{var t=l=>{try{u(n.next(l))}catch(m){s(m)}},d=l=>{try{u(n.throw(l))}catch(m){s(m)}},u=l=>l.done?i(l.value):Promise.resolve(l.value).then(t,d);u((n=n.apply(e,o)).next())});const oe=(e,o)=>{var n;const i=(o==null?void 0:o.fbx_url)||J,s=(n=o==null?void 0:o.north_rad)!=null?n:void 0,t={};let d={x:0,y:0,z:0},u=[0,0,0],l=1,m=s;e.on("modelLoaded",y);const z=r=>ee(void 0,null,function*(){var a;const p=(r==null?void 0:r.fbx_url)||i;if(m=(a=r==null?void 0:r.north_rad)!=null?a:s,typeof m!="number")throw new Error('"northRad"配置参数缺失：未配置指南针指向！');const f=yield new X().loadAsync(p);return Z(f,{transparent:!0,side:S,blending:I}),t.object=f,y(),!0}),h=({latitude:r})=>{if(!t.object)return;const a=b(r);a&&(t.object.position.y=a)},b=r=>{if(t.yBase===void 0)return;const a=.6;if(r>=Math.PI/4)return t.yBase-(a+1.6);const p=r*(4/Math.PI);return t.yBase-(a*p+1.6)},R=()=>{if(!t.object)return;const r=b(e.getPose().latitude);r&&(t.object.position.y=r),e.scene.add(t.object),e.needsRender=!0,e.on("cameraDirectionUpdate",h)},E=()=>{t.object&&(e.scene.remove(t.object),e.needsRender=!0,e.off("cameraDirectionUpdate",h))};function y(){const r=t.object;if(!r)return;const a=e.model.bounding,p=a.max.x-a.min.x,f=a.max.z-a.min.z,A=Math.max(p,f),{max:{x:D,z:C},min:{x:L,y:g,z:O}}=a;t.yBase=g,d={x:(D+L)/2,y:g-1.6,z:(C+O)/2},u=[0,m-Math.PI/2,0],l=.0045*A,Q(r,{position:d,rotation:u,scale:l})}return{load:z,disable:E,enable:R}};function P(){return{width:window.innerWidth,height:window.innerHeight}}function te(){const[e,o]=j.useState(P);return j.useEffect(()=>{const n=()=>o(P());return window.addEventListener("resize",n,!1),()=>window.removeEventListener("resize",n,!1)}),e}const ne=()=>{const[e,o]=W(),n=N(),i=k(),s=_(M.FLOOR_PLAN_SERVER_PLUGIN_DATA);return q("modelLoaded",async()=>{var d,u;if(!s||JSON.stringify(s)==="{}")return;const t=(u=(d=s==null?void 0:s.computed_data)==null?void 0:d.entrance)==null?void 0:u.north_rad;await n.plugins.modelChassisCompassPlugin.load({north_rad:t}),o({panoIndex:0,fov:106,latitude:-.07983208586321928,longitude:1.52265306535823,mode:x.Mode.Floorplan}),n.plugins.modelChassisCompassPlugin.enable()},[s]),i!=="Loaded"?null:c.jsx(K,{sx:{position:"fixed",bottom:0,left:0,right:0,backgroundColor:"transparent"},children:c.jsxs(V,{showLabels:!0,value:e.mode,onChange:(t,d)=>{o({mode:d})},children:[c.jsx(w,{label:"全景漫游",icon:c.jsx(H,{}),value:x.Mode.Panorama}),c.jsx(w,{label:"空间总览",icon:c.jsx(Y,{}),value:x.Mode.Floorplan})]})})},se=T({imageOptions:{size:512},textureOptions:{size:512},plugins:[[oe,"modelChassisCompassPlugin",{}]]}),re=()=>{const e=te(),o=_(M.WORK);return o&&c.jsxs(se,{initialWork:U(o),children:[c.jsx($,{...e}),c.jsx(ne,{})]})};G.render(c.jsx(re,{}),document.querySelector("#app"));
