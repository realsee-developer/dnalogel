import{F as we,V as W,r as te,n as Pe,q as xe,X as ye,j as E,G as ke,p as Ze,I as Re,a as Ge}from"./index-85b64ddc.js";import"./index-62a9cd62.js";import{u as ue,D as me}from"./useFetchDatas-45e33e50.js";import{B as Me}from"./Box-d96aca33.js";import{P as De}from"./Paper-ead7a250.js";import{B as We}from"./Button-c89038b2.js";import{C as fe,T as ve,F as ge,Q as Xe,K as z,X as je,g as $e,t as P,z as Ne,n as g,N as H,p as C,i as Ee,e as ze,a as se,J as L,a1 as be,G as F,o as U,L as Te,O as Se,$ as ne,c as Ae,d as Be,A as He,D as Le,R as Ve}from"./index-0b761db4.js";import{T as Je}from"./index-32625078.js";import{s as Oe}from"./Point-d3172315.js";import{b as Y}from"./equal-4c31728d.js";import{g as Ce}from"./planimetry-c68691e1.js";import"./createTheme-a7bd8e9d.js";import"./useTheme-28230d65.js";import"./ButtonBase-4df208c3.js";function Ye(l){Xe(l,"svelte-1h27ktp",".PanoRulerPlugin-rule-line.svelte-1h27ktp.svelte-1h27ktp{position:absolute;transform-origin:left 0.0625rem;width:0;height:0.125rem;pointer-events:none}.PanoRulerPlugin-rule-line.svelte-1h27ktp.svelte-1h27ktp::after{content:'';position:absolute;left:-0.125rem;top:-0.1rem;width:0.25rem;height:0.25rem;border-radius:50%;background:#fff;z-index:1;animation:svelte-1h27ktp-viewport-rule-point 0.1s 1s;animation-fill-mode:both}.PanoRulerPlugin-rule-line.svelte-1h27ktp.svelte-1h27ktp::before{content:'';position:absolute;right:-0.125rem;top:-0.1rem;width:0.25rem;height:0.25rem;border-radius:50%;background:#fff;z-index:1;animation:svelte-1h27ktp-viewport-rule-point 0.1s 1.5s;animation-fill-mode:both}.PanoRulerPlugin-rule-line.svelte-1h27ktp em.svelte-1h27ktp{display:block;height:0.0625rem;animation:svelte-1h27ktp-viewport-rule-line 0.5s ease 1s;animation-fill-mode:both;box-shadow:0 0 0.25rem rgb(0 0 0 / 40%);position:relative}.rule-mixed-line.svelte-1h27ktp.svelte-1h27ktp{display:flex;height:0.0625rem;animation:svelte-1h27ktp-viewport-rule-line 0.5s ease 1s;animation-fill-mode:both;align-items:center}.em-solid.svelte-1h27ktp.svelte-1h27ktp{height:100%;background:#ffffff}.em-dotted.svelte-1h27ktp.svelte-1h27ktp{height:0.125rem;background:var(--background-image);background-position:center;background-repeat:repeat}.PanoRulerPlugin-rule-label.svelte-1h27ktp.svelte-1h27ktp{position:absolute;width:0;height:0;top:0.0625rem;pointer-events:none}.PanoRulerPlugin-rule-label-name.svelte-1h27ktp.svelte-1h27ktp{position:absolute;padding:0.1875rem 0.375rem;background:rgba(195, 195, 195, 0.3);backdrop-filter:blur(0.25rem);-webkit-backdrop-filter:blur(0.25rem);border-radius:6.25rem;border:0.0625rem solid rgba(255, 255, 255, 0.6);white-space:nowrap;overflow:hidden;color:#ffffff;font-weight:500;font-size:0.75rem;line-height:1;animation:svelte-1h27ktp-viewport-rule-label 0.25s ease 1s;animation-fill-mode:both;box-shadow:inset 0 0 0.625rem 0 rgba(255, 255, 255, 0.3)}@keyframes svelte-1h27ktp-viewport-rule-line{0%{width:0%}100%{width:100%}}@keyframes svelte-1h27ktp-viewport-rule-label{0%{opacity:0;transform:scaleX(0)}100%{opacity:1;transform:translate(-50%, -50%) scaleX(1)}}@keyframes svelte-1h27ktp-viewport-rule-point{0%{transform:scaleX(0)}100%{transform:scaleX(1)}}")}function re(l,e,n){const o=l.slice();return o[6]=e[n],o}function Ue(l){let e,n=l[0].children,o=[];for(let t=0;t<n.length;t+=1)o[t]=ae(re(l,n,t));return{c(){e=z("div");for(let t=0;t<o.length;t+=1)o[t].c();P(e,"class","rule-mixed-line svelte-1h27ktp")},m(t,i){H(t,e,i);for(let s=0;s<o.length;s+=1)o[s]&&o[s].m(e,null)},p(t,i){if(i&9){n=t[0].children;let s;for(s=0;s<n.length;s+=1){const r=re(t,n,s);o[s]?o[s].p(r,i):(o[s]=ae(r),o[s].c(),o[s].m(e,null))}for(;s<o.length;s+=1)o[s].d(1);o.length=n.length}},d(t){t&&L(e),be(o,t)}}}function Fe(l){let e,n;return{c(){e=z("em"),P(e,"class",n=F(l[0].state?"em-solid":"em-dotted")+" svelte-1h27ktp"),P(e,"style",l[3])},m(o,t){H(o,e,t)},p(o,t){t&1&&n!==(n=F(o[0].state?"em-solid":"em-dotted")+" svelte-1h27ktp")&&P(e,"class",n),t&8&&P(e,"style",o[3])},d(o){o&&L(e)}}}function ae(l){let e,n,o=`${l[6].width}px`;return{c(){e=z("div"),P(e,"class",n=F(l[6].state?"em-solid":"em-dotted")+" svelte-1h27ktp"),P(e,"style",l[3]),g(e,"width",o)},m(t,i){H(t,e,i)},p(t,i){i&1&&n!==(n=F(t[6].state?"em-solid":"em-dotted")+" svelte-1h27ktp")&&P(e,"class",n),i&8&&P(e,"style",t[3]),(i&8||i&9&&o!==(o=`${t[6].width}px`))&&g(e,"width",o)},d(t){t&&L(e)}}}function Qe(l){let e,n,o,t,i=l[0].labelElement+"",s,r,a=`${l[0].labelOffset}%`,h=`${l[0].width}px`,R=`${l[0].left}px`,x=`${l[0].top}px`,y=`rotate(${l[0].rotateDeg}deg)`;function V(d,u){return d[0].children.length===0?Fe:Ue}let j=V(l),I=j(l);return{c(){e=z("div"),I.c(),n=je(),o=z("div"),t=z("div"),s=$e(i),P(t,"class","PanoRulerPlugin-rule-label-name svelte-1h27ktp"),Ne(()=>l[4].call(t)),P(o,"class","PanoRulerPlugin-rule-label svelte-1h27ktp"),g(o,"left",a),P(e,"class","PanoRulerPlugin-rule-line svelte-1h27ktp"),g(e,"width",h),g(e,"left",R),g(e,"top",x),g(e,"transform",y),g(e,"display",l[0].visible&&l[2]?"block":"none")},m(d,u){H(d,e,u),I.m(e,null),C(e,n),C(e,o),C(o,t),C(t,s),r=Ee(t,l[4].bind(t))},p(d,[u]){j===(j=V(d))&&I?I.p(d,u):(I.d(1),I=j(d),I&&(I.c(),I.m(e,n))),u&1&&i!==(i=d[0].labelElement+"")&&ze(s,i),u&1&&a!==(a=`${d[0].labelOffset}%`)&&g(o,"left",a),u&1&&h!==(h=`${d[0].width}px`)&&g(e,"width",h),u&1&&R!==(R=`${d[0].left}px`)&&g(e,"left",R),u&1&&x!==(x=`${d[0].top}px`)&&g(e,"top",x),u&1&&y!==(y=`rotate(${d[0].rotateDeg}deg)`)&&g(e,"transform",y),u&5&&g(e,"display",d[0].visible&&d[2]?"block":"none")},i:se,o:se,d(d){d&&L(e),I.d(),r()}}}function qe(l,e,n){let o,{rulerItemProp:t}=e,i=!0,s,r="data:image/svg+xml;base64,PHN2ZyBoZWlnaHQ9IjQiIHdpZHRoPSIxMiIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayI+PGRlZnM+PGZpbHRlciBpZD0icHJlZml4X19hIiBoZWlnaHQ9IjQwMCUiIHdpZHRoPSIxMzcuNCUiIHg9Ii0xOC43JSIgeT0iLTE1MCUiPjxmZU1vcnBob2xvZ3kgaW49IlNvdXJjZUFscGhhIiBvcGVyYXRvcj0iZGlsYXRlIiByYWRpdXM9Ii41IiByZXN1bHQ9InNoYWRvd1NwcmVhZE91dGVyMSIvPjxmZU9mZnNldCBpbj0ic2hhZG93U3ByZWFkT3V0ZXIxIiByZXN1bHQ9InNoYWRvd09mZnNldE91dGVyMSIvPjxmZU1vcnBob2xvZ3kgaW49IlNvdXJjZUFscGhhIiByYWRpdXM9IjEiIHJlc3VsdD0ic2hhZG93SW5uZXIiLz48ZmVPZmZzZXQgaW49InNoYWRvd0lubmVyIiByZXN1bHQ9InNoYWRvd0lubmVyIi8+PGZlQ29tcG9zaXRlIGluPSJzaGFkb3dPZmZzZXRPdXRlcjEiIGluMj0ic2hhZG93SW5uZXIiIG9wZXJhdG9yPSJvdXQiIHJlc3VsdD0ic2hhZG93T2Zmc2V0T3V0ZXIxIi8+PGZlR2F1c3NpYW5CbHVyIGluPSJzaGFkb3dPZmZzZXRPdXRlcjEiIHJlc3VsdD0ic2hhZG93Qmx1ck91dGVyMSIgc3RkRGV2aWF0aW9uPSIuNSIvPjxmZUNvbG9yTWF0cml4IGluPSJzaGFkb3dCbHVyT3V0ZXIxIiB2YWx1ZXM9IjAgMCAwIDAgMCAwIDAgMCAwIDAgMCAwIDAgMCAwIDAgMCAwIDAuMiAwIi8+PC9maWx0ZXI+PHBhdGggaWQ9InByZWZpeF9fYiIgZD0iTS44ODkgMkgxMS41OCIvPjwvZGVmcz48ZyBmaWxsPSJub25lIiBmaWxsLXJ1bGU9ImV2ZW5vZGQiIHN0cm9rZS1kYXNoYXJyYXk9IjUgNiIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIj48dXNlIGZpbGw9IiMwMDAiIGZpbHRlcj0idXJsKCNwcmVmaXhfX2EpIiB4bGluazpocmVmPSIjcHJlZml4X19iIi8+PHVzZSBzdHJva2U9IiNmZmYiIHN0cm9rZS1vcGFjaXR5PSIuNCIgeGxpbms6aHJlZj0iI3ByZWZpeF9fYiIvPjwvZz48L3N2Zz4=";function a(){s=this.offsetWidth,n(1,s)}return l.$$set=h=>{"rulerItemProp"in h&&n(0,t=h.rulerItemProp)},l.$$.update=()=>{l.$$.dirty&3&&(s>=t.width||s/2>=t.labelOffset/100*t.width||s/2>=(1-t.labelOffset/100)*t.width?n(2,i=!1):n(2,i=!0))},n(3,o=`--background-image: url(${r})`),[t,s,i,o,a]}class _e extends fe{constructor(e){super(),ve(this,e,qe,Qe,ge,{rulerItemProp:0},Ye)}}function ie(l,e,n){const o=l.slice();return o[12]=e[n],o}function de(l){let e,n;return e=new _e({props:{rulerItemProp:l[12]}}),{c(){He(e.$$.fragment)},m(o,t){Le(e,o,t),n=!0},p(o,t){const i={};t&1&&(i.rulerItemProp=o[12]),e.$set(i)},i(o){n||(U(e.$$.fragment,o),n=!0)},o(o){ne(e.$$.fragment,o),n=!1},d(o){Ve(e,o)}}}function Ke(l){let e,n,o=l[0],t=[];for(let s=0;s<o.length;s+=1)t[s]=de(ie(l,o,s));const i=s=>ne(t[s],1,1,()=>{t[s]=null});return{c(){e=z("div");for(let s=0;s<t.length;s+=1)t[s].c()},m(s,r){H(s,e,r);for(let a=0;a<t.length;a+=1)t[a]&&t[a].m(e,null);n=!0},p(s,[r]){if(r&1){o=s[0];let a;for(a=0;a<o.length;a+=1){const h=ie(s,o,a);t[a]?(t[a].p(h,r),U(t[a],1)):(t[a]=de(h),t[a].c(),U(t[a],1),t[a].m(e,null))}for(Te(),a=o.length;a<t.length;a+=1)i(a);Se()}},i(s){if(!n){for(let r=0;r<o.length;r+=1)U(t[r]);n=!0}},o(s){t=t.filter(Boolean);for(let r=0;r<t.length;r+=1)ne(t[r]);n=!1},d(s){s&&L(e),be(t,s)}}}function et(l,e,n){var o,t,i,s;let{five:r}=e,{rulerDatas:a}=e,{options:h}=e,R=[];const x=((t=(o=r.getElement())==null?void 0:o.parentElement)==null?void 0:t.clientWidth)||0,y=((s=(i=r.getElement())==null?void 0:i.parentElement)==null?void 0:s.clientHeight)||0,V=(p,m)=>{const f=[[{x:0,y:0},{x,y:0}],[{x:0,y:0},{x:0,y}],[{x,y:0},{x,y}],[{x:0,y},{x,y}]],b=[];for(let w=0;w<f.length;w++){const G=Ce([p,m],[f[w][0],f[w][1]],!0);G&&b.push(G)}return b.length===0?!1:b},j=(p,m)=>{const f=p.clone().project(r.camera),b=(f.x+1)/2*x,w=(-f.y+1)/2*y,G=m.clone().project(r.camera),T=(G.x+1)/2*x,X=(-G.y+1)/2*y,c=Math.sqrt(Math.pow(T-b,2)+Math.pow(X-w,2));return{startLeft:b,startTop:w,endLeft:T,endTop:X,distance:c}},I=(p,m,f)=>{const b=r.camera.position,w=r.camera.getWorldDirection(new W),G=p.clone().sub(b).normalize().angleTo(w),T=m.clone().sub(b).normalize().angleTo(w),X=p.distanceTo(m),c=m.clone().sub(m.clone().sub(p).divide(new W(2,2,2))).distanceTo(b),{startLeft:k,startTop:Z,endLeft:M,endTop:$,distance:N}=j(p,m),Q=-((Math.PI/2-Math.atan2(M-k,Z-$))/Math.PI)*180;let D=!0;f||(D=!1),!Y(p,f)&&!Y(m,f)&&(D=!1),X<.3&&(D=!1),G>Math.PI/2&&(D=!1),T>Math.PI/2&&(D=!1),c/X>8&&(D=!1);let S=50,A=N;const v=V({x:~~k,y:~~Z},{x:~~M,y:~~$});if(v&&v.length===1&&(Y(p,f)?(A=Math.sqrt(Math.pow(v[0].x-k,2)+Math.pow(v[0].y-Z,2)),S=A/N*50):Y(m,f)&&(A=Math.sqrt(Math.pow(v[0].x-M,2)+Math.pow(v[0].y-$,2)),S=100-A/N*50)),v&&v.length===2){const O={x:(v[0].x+v[1].x)/2,y:(v[0].y+v[1].y)/2};S=Math.sqrt(Math.pow(O.x-k,2)+Math.pow(O.y-Z,2))/N*100}return{startLeft:k,startTop:Z,distance:N,deg:Q,visible:D,labelOffset:S,ruleLength:X}},d=()=>{const p=r.panoIndex,m=a.find(c=>c.panoIndex===p);if(!m)return n(0,R=[]);if(r.currentMode!==we.Mode.Panorama)return n(0,R=[]);const f=r.camera.position,b=r.camera.getWorldDirection(new W),w=m.lines.map(c=>new W(c.start[0],-c.start[1],-c.start[2])),G=m.lines.map(c=>new W(c.end[0],-c.end[1],-c.end[2])),[T]=w.concat(G).sort((c,k)=>{const Z=c.clone().setY(0).sub(f).normalize().angleTo(b.clone().setY(0)),M=k.clone().setY(0).sub(f).normalize().angleTo(b.clone().setY(0));return Z-M}),X=m.lines.map(c=>{var k,Z;const M=c.start,$=c.end,{startLeft:N,startTop:Q,distance:D,deg:S,visible:A,labelOffset:v,ruleLength:O}=I(new W(M[0],-M[1],-M[2]),new W($[0],-$[1],-$[2]),T),le=[];return c.children&&((k=c.children)==null?void 0:k.length)>0&&((Z=c.children)==null||Z.forEach(q=>{const _=q.start,K=q.end,{distance:Ie}=j(new W(_[0],-_[1],-_[2]),new W(K[0],-K[1],-K[2]));le.push({width:Ie,state:q.state})})),{width:D,left:N,top:Q,rotateDeg:S,state:c.state,children:le,labelOffset:v,visible:A,labelElement:h.distanceText(O)}});n(0,R=X)},u=()=>Je(d),J=Oe(d,80);return Ae(()=>{d(),r.on("panoArrived",d),r.on("modeChange",d),r.on("cameraDirectionUpdate",u),r.on("movingToPano",u),r.on("mouseWheel",()=>J()),r.on("pinchGesture",()=>J())}),Be(()=>{r.off("panoArrived",d),r.off("modeChange",d),r.off("cameraDirectionUpdate",u),r.off("movingToPano",u),r.off("mouseWheel",()=>J()),r.off("pinchGesture",()=>J())}),l.$$set=p=>{"five"in p&&n(1,r=p.five),"rulerDatas"in p&&n(2,a=p.rulerDatas),"options"in p&&n(3,h=p.options)},[R,r,a,h]}class tt extends fe{constructor(e){super(),ve(this,e,et,Ke,ge,{five:1,rulerDatas:2,options:3})}}var nt=Object.defineProperty,ce=Object.getOwnPropertySymbols,ot=Object.prototype.hasOwnProperty,lt=Object.prototype.propertyIsEnumerable,oe=(l,e,n)=>e in l?nt(l,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):l[e]=n,pe=(l,e)=>{for(var n in e||(e={}))ot.call(e,n)&&oe(l,n,e[n]);if(ce)for(var n of ce(e))lt.call(e,n)&&oe(l,n,e[n]);return l},B=(l,e,n)=>(oe(l,typeof e!="symbol"?e+"":e,n),n),ee=(l,e,n)=>new Promise((o,t)=>{var i=a=>{try{r(n.next(a))}catch(h){t(h)}},s=a=>{try{r(n.throw(a))}catch(h){t(h)}},r=a=>a.done?o(a.value):Promise.resolve(a.value).then(i,s);r((n=n.apply(l,e)).next())});class st{constructor(e,n){B(this,"five"),B(this,"container",document.createElement("div")),B(this,"panoRulerProData"),B(this,"rulerItems"),B(this,"state",{enabled:!1,loaded:!1,options:{className:"",distanceText:i=>`${i.toFixed(1)}m`}});var o,t;this.five=e,this.container.classList.add("panoRulerProPlugin-container"),this.container.setAttribute("style","position: absolute;pointer-events: none;width: 100%;height: 100%;left: 0;top: 0;overflow: hidden;"),n&&(n.data&&this.load(n.data),this.state.options=pe(pe({},this.state.options),n.options||{}),(o=n.options)!=null&&o.className&&this.container.classList.add((t=n.options)==null?void 0:t.className)),this.five.once("modelLoaded",()=>ee(this,null,function*(){var i,s;(s=(i=this.five.getElement())==null?void 0:i.parentNode)==null||s.append(this.container)})),this.five.once("dispose",()=>this.dispose())}load(e){return ee(this,null,function*(){if(!this.five.work)return;const n=e.data;if(!n)throw new Error("标尺数据依赖不齐全！");this.panoRulerProData=n,this.state.loaded=!0})}enable(){return this.state.loaded?(this.state.enabled||(this.state.enabled=!0,this.render()),!0):!1}disable(){return this.state.enabled&&(this.state.enabled=!1,this.render()),!0}render(){return ee(this,null,function*(){var e;if(this.state.enabled){if(!this.panoRulerProData||!this.container)return;this.rulerItems=new tt({target:this.container,props:{five:this.five,rulerDatas:this.panoRulerProData,options:this.state.options}})}else(e=this.rulerItems)==null||e.$destroy(),this.rulerItems=void 0})}dispose(){var e;this.container&&((e=this.rulerItems)==null||e.$destroy(),this.rulerItems=void 0),this.container.remove()}}const rt=(l,e)=>new st(l,e);function he(){return{width:window.innerWidth,height:window.innerHeight}}function at(){const[l,e]=te.useState(he);return te.useEffect(()=>{const n=()=>e(he());return window.addEventListener("resize",n,!1),()=>window.removeEventListener("resize",n,!1)}),l}const it=l=>{const e=Pe(),o=xe().plugins.panoRulerProPlugin,t=ue(me.PANO_RULER_PRO_PLUGIN_SERVER_DATA,"80o024DE2xyva3j5BE","real"),[i,s]=te.useState(o.state.enabled);ye("modelLoaded",async()=>{t&&(console.info({data:t,version:0}),await o.load({data:t,version:0}),o.enable(),s(o.state.enabled))},[t]);const r=()=>{o[o.state.enabled?"disable":"enable"](),s(o.state.enabled)};return e!=="Loaded"?null:E.jsx(Me,{children:E.jsx(De,{sx:{position:"fixed",top:"10px",right:"10px",backgroundColor:"transparent"},children:E.jsx(We,{onClick:r,children:i?"关闭标尺":"开启标尺"})})})},dt=ke({imageOptions:{size:512},textureOptions:{size:512},onlyRenderIfNeeds:!0,plugins:[[rt,"panoRulerProPlugin",{options:{distanceText:l=>`约 ${l.toFixed(1)}米`}}]]}),ct=()=>{const l=at(),e=ue(me.WORK,"80o024DE2xyva3j5BE","real");return e&&E.jsxs(dt,{initialWork:Ze(e),children:[E.jsx(Re,{...l}),E.jsx(it,{})]})};Ge.render(E.jsx(ct,{}),document.querySelector("#app"));
