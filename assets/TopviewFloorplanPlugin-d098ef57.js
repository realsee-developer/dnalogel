import{V as D,q as _,J as M,n as k,r as x,j as d,F as C,T as R,G as U,p as N,I as z,a as B}from"./index-85b64ddc.js";import{E as W}from"./index-62a9cd62.js";import{u as G}from"./useWindowDimensions-e9a574a8.js";import{d as H,a as $}from"./ViewInAr-fd4fa02b.js";import{u as I,D as L}from"./useFetchDatas-45e33e50.js";import{P as F}from"./Paper-ead7a250.js";import{B as J}from"./ButtonGroup-da6043f4.js";import{B as q}from"./Button-c89038b2.js";import{B as V,a as S}from"./BottomNavigationAction-2b30d94e.js";import{g as Y}from"./getInitialParamFromUrl-5dd39f79.js";import{b as K}from"./equal-4c31728d.js";import{a as Q,m as X,A as Z,r as tt,e as et,l as it,b as st,E as ot,P as y,j as nt,c as P}from"./replace-static-prefix-c62e98bc.js";import{t as at}from"./Point-d3172315.js";import{B as rt}from"./Box-d96aca33.js";import"./createTheme-a7bd8e9d.js";import"./createSvgIcon-c7bdef24.js";import"./createSvgIcon-0da8929c.js";import"./ButtonBase-4df208c3.js";import"./useControlled-e139503c.js";import"./useId-457cb0cd.js";import"./index-0b761db4.js";import"./index-94bb1ebd.js";import"./useTheme-28230d65.js";var ht=Object.defineProperty,lt=Object.defineProperties,dt=Object.getOwnPropertyDescriptors,T=Object.getOwnPropertySymbols,ct=Object.prototype.hasOwnProperty,ut=Object.prototype.propertyIsEnumerable,A=(h,t,e)=>t in h?ht(h,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):h[t]=e,u=(h,t)=>{for(var e in t||(t={}))ct.call(t,e)&&A(h,e,t[e]);if(T)for(var e of T(t))ut.call(t,e)&&A(h,e,t[e]);return h},g=(h,t)=>lt(h,dt(t)),o=(h,t,e)=>(A(h,typeof t!="symbol"?t+"":t,e),e),f=(h,t,e)=>new Promise((a,s)=>{var r=c=>{try{p(e.next(c))}catch(i){s(i)}},l=c=>{try{p(e.throw(c))}catch(i){s(i)}},p=c=>c.done?a(c.value):Promise.resolve(c.value).then(r,l);p((e=e.apply(h,t)).next())});class pt extends Q{constructor(t,e){var a,s;super(t),o(this,"name","topviewFloorplanPlugin"),o(this,"state"),o(this,"data"),o(this,"app"),o(this,"selector"),o(this,"panoIndex",0),o(this,"floorIndex",0),o(this,"wrapper"),o(this,"container",document.createElement("div")),o(this,"lastPanoramaLongitude",0),o(this,"size",{width:0,height:0}),o(this,"defaultMissingFloorConfig"),o(this,"hasAddedEventListener",!1),o(this,"isHiddenByHideFunc",!1),o(this,"highlightData",{}),o(this,"updateSize",()=>{if(!this.data||!this.container||!this.wrapper||this.five.getCurrentState().mode!=="Topview")return!1;const{min:i,max:n}=this.data.bounding,v=n.x-i.x,m=n.y-i.y,O=this.state.config.attachedTo?{attachedTo:this.state.config.attachedTo}:void 0,E=ot(this.five,this.wrapper,this.floorIndex,O),b=Math.ceil(v*E),w=Math.ceil(m*E);return this.size.width===b&&this.size.height===w||(this.container.style.width=b+"px",this.container.style.height=w+"px",this.size={width:b,height:w}),!0}),o(this,"dispose",()=>{var i,n;this.removeEventListener(),(i=this.app)==null||i.$destroy(),this.app=void 0,(n=this.container)==null||n.remove(),this.data=void 0,this.wrapper=void 0,this.selector=void 0,this.hooks.emit("dispose")}),o(this,"highlight",i=>{this.state.config.highlightEnable&&(this.highlightData=i,this.render())}),o(this,"unhighlight",()=>{this.highlightData={},this.render()}),o(this,"_disable",i=>{var n,v;const{userAction:m}=i;(n=this.app)==null||n.$destroy(),this.app=void 0,(v=this.container)==null||v.remove(),this.removeEventListener(),this.hooks.emit("disable",{userAction:m})}),o(this,"onFiveModelLoaded",()=>{if(this.state.enabled===!1||this.wrapper||!this.selector)return;const i=this.selector instanceof Element?this.selector:document.querySelector(this.selector);if(!i)throw new Error("不正确的父容器选择器");this.wrapper=i,i.append(this.container)}),o(this,"onFiveModeChange",(...[i,,,,n])=>{i!=="Topview"&&this.state.visible&&(this.updateState({visible:!1},n),this._hide({userAction:n}))}),o(this,"onFivePanoArrived",i=>{var n;(n=this.five)!=null&&n.work&&(this.panoIndex=i,this.floorIndex=this.workUtil.observers[i].floorIndex)}),o(this,"onFiveCameraUpdate",(i,n)=>{this.state.visible&&(this.updatePosition(),this.updateSize())}),o(this,"onFiveWantsGesture",i=>{if(!(i!=="pan"&&i!=="pinch"&&i!=="mouseWheel")&&this.state.visible&&!this.state.config.gestureEnable)return!1}),o(this,"onFiveWantsMoveToPano",()=>{if(this.state.visible&&this.state.config.preventRoomClick)return!1}),o(this,"onFiveInitAnimationEnded",(...[,,i])=>{const{mode:n}=this.five.getCurrentState();n==="Topview"&&!this.isHiddenByHideFunc&&!this.state.visible&&this.state.config.autoShowEnable&&(this.updateState({visible:!0},i),this._show({userAction:i}))}),o(this,"onModelShownFloorChange",i=>{if(this.floorIndex!==i){if(i===null){const n=this.five.getCurrentState().panoIndex;this.floorIndex=this.workUtil.observers[n].floorIndex;return}this.floorIndex=i,this.updateSize(),this.render()}}),e!=null&&e.selector&&(this.selector=e.selector,console.warn("不推荐继续使用 params.selector 配置父容器，请使用 appendTo 方法")),this.defaultMissingFloorConfig={imageURL:X(e==null?void 0:e.staticPrefix,W),imageWidth:200,imageHeight:120,text:(s=(a=e.i18n)==null?void 0:a.call(e,"暂无平面图"))!=null?s:"暂无平面图",textFontSize:14};const r={northDesc:"北",modelOpacity:1,cameraEnable:!0,hoverEnable:!0,highlightEnable:!1,compassEnable:!0,gestureEnable:!1,autoShowEnable:!0,ruleLabelsEnable:!0,roomLabelsEnable:!0,roomAreaEnable:!0,roomNameEnable:!0,roomNameOtherTypeEnable:!0,roomDimensionEnable:!0,cameraImageUrl:Z,attachedTo:tt.BOUNDING_CENTER,getLabelElement:void 0,missingFloorConfig:u(u({},this.defaultMissingFloorConfig),e.missingFloorConfig),i18n:i=>i,adaptiveRoomLabelVisibleEnable:!0,getRoomAreaText:i=>(i/1e6).toFixed(1)+"㎡",getRoomDimensionText:(i,n)=>(i/1e3).toFixed(1)+"m × "+(n/1e3).toFixed(1)+"m",getRuleDistanceText:i=>i.toString()},l=e?et(e,["selector","scale"]):{},p=u(u({},r.missingFloorConfig),l.missingFloorConfig),c=g(u(u({},r),l),{missingFloorConfig:p});this.state={enabled:!0,visible:!1,config:c},this.initContainer(),t.model.loaded?this.onFiveModelLoaded():t.once("modelLoaded",this.onFiveModelLoaded),t.once("dispose",this.dispose),this.addEventListener()}load(t,e,a=!0){return f(this,null,function*(){function s(i){return Object.prototype.hasOwnProperty.apply(i,["version"])}const r=t;r&&at(r.version)&&console.warn("传入 serverData.data 的方式后续可能不再支持，请把 serverData 整体传入 load 函数");const l=JSON.parse(JSON.stringify(t)),p=s(l)?l.data:l,c=this.data;this.data=yield y(p),this.hooks.emit("dataLoaded",this.data),this.hooks.emit("dataChange",this.data,c),e&&this.updateState(e,a),this.render()})}updatePosition(){var t;const e=it(this.five,this.floorIndex,this.state.config.attachedTo),a=(t=this.five.model)==null?void 0:t.bounding.getCenter(new D).setY(e);if(!a)return;const s=a.clone().project(this.five.camera),r=(s.x+1)/2,l=-(s.y-1)/2;this.container.style.left=r*100+"%",this.container.style.top=l*100+"%"}appendTo(t){if(this.wrapper=t,!!this.state.enabled)return t.appendChild(this.container),this.render(),this}show(){return f(this,arguments,function*(t={}){if(this.state.visible)return;const e=t.userAction!==void 0?t.userAction:!0;this.updateState({visible:!0},e),this._show({userAction:e})})}hide(){return f(this,arguments,function*(t={}){if(this.isHiddenByHideFunc=!0,!this.state.visible)return;const e=t.userAction!==void 0?t.userAction:!0;this.updateState({visible:!1},e),this._hide({userAction:e})})}enable(t={}){if(this.state.enabled)return;const e=t.userAction!==void 0?t.userAction:!0;this.updateState({enabled:!0},t.userAction||e),this._enable({userAction:e})}disable(t={}){if(!this.state.enabled)return;const e=t.userAction!==void 0?t.userAction:!0;this.updateState({enabled:!1},t.userAction||e),this._disable({userAction:e})}setState(t,e={}){const a=this.state,s=e.userAction!==void 0?e.userAction:!0;if(this.updateState(t,s),t.enabled!==void 0&&a.enabled!==t.enabled){const r={userAction:s};t.enabled?this._enable(r):this._disable(r)}if(t.visible!==void 0&&a.visible!==t.visible){const r={userAction:s};t.visible?this._show(r):this._hide(r)}}changeConfigs(t,e=!0){this.updateState({config:t},e),this.render()}formatData(t){return f(this,null,function*(){return yield y(t.data)})}_show(t){return f(this,null,function*(){if(!this.state.enabled)return;this.isHiddenByHideFunc=!1;const{userAction:e}=t;this.hooks.emit("show",{userAction:e,auto:!1}),this.five.getCurrentState().mode!=="Topview"&&(yield nt(this.five,["Topview",void 0,void 0,e])),this.five.model.show(this.floorIndex),this.updatePosition(),this.updateSize();const a=500,s=this.state.config.modelOpacity;P(this.five,s,a),this.hooks.emit("showAnimationEnded",{userAction:e,auto:!1}),this.render()})}_hide(t){return f(this,null,function*(){if(!this.state.enabled)return;const{userAction:e}=t;this.hooks.emit("hide",{userAction:e,auto:!1});const a=1,s=0;P(this.five,a,s),this.render()})}_enable(t){const{userAction:e}=t;this.addEventListener(),this.wrapper&&this.wrapper.append(this.container),this.hooks.emit("enable",{userAction:e}),this.state.visible&&this._show({userAction:e})}updateState(t,e){var a;const s=this.state,r=(a=t.config)!=null&&a.missingFloorConfig?u(u({},s.config.missingFloorConfig),t.config.missingFloorConfig):s.config.missingFloorConfig,l=t.config?g(u(u({},s.config),t.config),{missingFloorConfig:r}):s.config;this.state=g(u(u({},this.state),t),{config:l}),!K(this.state,s,{deep:!0})&&this.hooks.emit("stateChange",{state:this.state,prevState:s,userAction:e})}addEventListener(){if(!this.state.enabled||this.hasAddedEventListener)return;const t=this.five;t.on("modeChange",this.onFiveModeChange),t.on("panoArrived",this.onFivePanoArrived),t.on("cameraUpdate",this.onFiveCameraUpdate),t.on("wantsGesture",this.onFiveWantsGesture),t.on("wantsMoveToPano",this.onFiveWantsMoveToPano),t.on("initAnimationEnded",this.onFiveInitAnimationEnded),t.on("modelShownFloorChange",this.onModelShownFloorChange)}removeEventListener(){const t=this.five;this.hasAddedEventListener=!1,t.off("modeChange",this.onFiveModeChange),t.off("panoArrived",this.onFivePanoArrived),t.off("cameraUpdate",this.onFiveCameraUpdate),t.off("wantsGesture",this.onFiveWantsGesture),t.off("wantsMoveToPano",this.onFiveWantsMoveToPano),t.off("initAnimationEnded",this.onFiveInitAnimationEnded),t.off("modelShownFloorChange",this.onModelShownFloorChange)}initContainer(){this.container.classList.add("floorplan-plugin"),Object.assign(this.container.style,{position:"absolute",left:"50%",top:"50%",transform:"translate3d(-50%, -50%, 10px)",zIndex:10,pointerEvents:"none","will-change":"width, height"}),this.five.addExtraElement(this.container)}render(t){if(!this.state.enabled||!this.container||!this.data||this.size.width===0)return;const e=g(u({},this.state.config),{visible:this.state.visible,duration:t??0,panoIndex:this.panoIndex,floorIndex:this.floorIndex,floorplanData:this.data,lastPanoramaLongitude:this.lastPanoramaLongitude,highlightData:this.highlightData});if(this.app)return this.app.$set(e);this.app=new st({target:this.container,intro:!0,props:e})}}const ft=(h,t)=>new pt(h,t),vt=()=>{const h=_(),[t,e]=M(),a=k(),s=I(L.FLOOR_PLAN_SERVER_PLUGIN_DATA),r=h.plugins.topviewFloorplanPlugin,[l,p]=x.useState(!0);function c(){p(!l)}return x.useEffect(()=>{r.changeConfigs({getRoomAreaText(i){return l?(i/1e6).toFixed(1)+"㎡":(i*10764e-9).toFixed(1)+"ft²"},getRuleDistanceText(i){return l?i.toString():(i*.0032808).toFixed(1)+"ft"}})},[l]),x.useEffect(()=>{!s||JSON.stringify(s)==="{}"||(r.load(s),r.appendTo(document.querySelector(".plugin-full-screen-container")))},[s]),a!=="Loaded"?null:d.jsxs(F,{sx:{width:"100%",height:"100%"},children:[d.jsx(F,{sx:{position:"absolute",top:"10px",right:"10px",backgroundColor:"transparent"},children:d.jsx(J,{size:"large","aria-label":"large button group",orientation:"vertical",variant:"contained",children:d.jsx(q,{variant:"contained",onClick:c,children:"切换单位"})})}),d.jsx(F,{sx:{position:"fixed",bottom:0,left:0,right:0,backgroundColor:"transparent"},className:"topview-floorplan-plugin-use",children:d.jsxs(V,{showLabels:!0,value:t.mode,onChange:(i,n)=>{e({mode:n})},children:[d.jsx(S,{label:"全景漫游",icon:d.jsx(H,{}),value:C.Mode.Panorama},1),d.jsx(S,{label:"俯视模型",icon:d.jsx($,{}),value:C.Mode.Topview},2)]},"topview-floorplan-plugin")})]})};Object.assign(window,{THREE:R});const gt={hoverEnable:!0,northDesc:"N"},j=Y(),mt=Object.assign(gt,JSON.stringify(j)!=="{}"?j:{}),bt=U({imageOptions:{size:512},textureOptions:{size:512},plugins:[[ft,"topviewFloorplanPlugin",{...mt}]]}),wt=()=>{const h=G(),t=I(L.WORK);return t&&d.jsxs(bt,{initialWork:N(t),children:[d.jsx(z,{...h},"five-canvas"),d.jsx(rt,{className:"plugin-full-screen-container",sx:{position:"absolute",top:0,left:0,width:"100%",height:"100%",pointerEvents:"none"}},"box"),d.jsx(vt,{},"plugin-use")]})};B.render(d.jsx(wt,{}),document.querySelector("#app"));
